<!DOCTYPE html>
<html>
    <head>
        <title>Websocket Based HTML5 IRC Client</title>
	<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
	  <style type="text/css">
		div{
		display:inline;
		}
		div.nick {
		color: #FFC000;
		font-family:arial;
		vertical-align:text-top;
		font-size: 12pt;
		}
		div.timestamp {
		color : white;
		font-family:arial;
		vertical-align:text-top;
		font-size: 12pt;
		}
		div.chat {
		color : white;
		font-family:arial;
		vertical-align:text-top;
		font-size: 12pt;
		}
		
	</style>
    </head>
    <body style="font-family:  Helvetica, Arial, sans-serif; font-size: 24pt" bgcolor="#151515">
        <p style="color:#FFC000;width: 800px">Websocket Based HTML5 IRC Client</p>
        <div id="viz"></div>
        <form id="conversation" onsubmit="DispatchText()" action="javascript:void(0);">
            <input type="text" id="message" name="message" autocomplete="off" style="width:700px" />
            <input type="submit" id="sub" name="sub" value="Send" style="width:90px" />
        </form>
        <script type="text/javascript">
		var sampleSVG = d3.select("#viz")
			.append("svg")
			.attr("width", 800)
			.attr("height", 500);
		var ws = new WebSocket("ws://127.0.0.1:8888/websocket");
		var message_list = new Array();
		ws.onmessage = function(evt)
		{
			var p = JSON.parse(evt.data);
			FilterJSON(p);
			message_list.push(p);
			if(message_list.length > 10){message_list.shift();}
			Update();
		}
		function DispatchText(){
			var userInput = document.getElementById("message").value;
			document.getElementById("message").value = "";
			ws.send(userInput);
		}
		function Update(){
			var g = sampleSVG.selectAll("g").data(message_list, function(d) { return d.friendly_time; });

			var enter_g = g.enter().append("g").attr("transform","translate(15,600)");

			enter_g.append("rect")
			.attr("rx", 6)
			.attr("ry", 6)
			.attr("x", 0)
			.attr("y", 0)
			.attr("width", 700)
			.attr("height", 28)
			.style("fill","black")
			.style("stroke","white");

			enter_g.append('foreignObject')
			.attr('x', 0)
			.attr('y', 0)
			.attr('width', 700)
			.attr('height', 24)
			.append("xhtml:body")
			.html(function(d) { return '<div class="timestamp">' + d.friendly_time + ' | </div><div class="nick">' + d.nick + '</div><div class="chat"> | ' + d.args[1] + '</div>'; });
			
			g.transition()
			.duration(500)
			.attr("transform", function(d,i){return "translate(15,"+ (i+1)*32 +")";});
			
			g.exit().remove();
		}
		//filter the incoming chat in the client so we can more closely control switching on/off
		//various filters
		function FilterJSON(data)
		{
			var previous_chat = data.args[1];
			data.args[1] = previous_chat.replace(/(http:\/\/[\w\-\.]+\.[a-zA-Z]{2,3}(?:\/\S*)?(?:[\w])+\.(?:jpg|png|gif|jpeg|bmp))/ig, "<img src='$1' align='top' alt=''>");
		}
        </script>
    </body>
</html>
